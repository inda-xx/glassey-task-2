name: Generate QLC
run-name: Generates a question about learner code

on:
  issues:
    types: [opened]

jobs:
  List-Java-Files:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.title == 'AMA' || github.event.issue.title == 'ama' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Install python packages
      run: |
          python -m pip install --upgrade pip
          pip install -r .github/workflows/requirements.txt

    - name: Get all source files
      run: |
        echo "::set-output name=files::$(find . -name "*.java")"
        
    - name: Generate question
      run: |
        python .github/workflows/qlc_local.py ${{ steps.list_files.outputs.files }} ${{ secrets.OPENAI_TOKEN }}
    
    - name: Update issue
      env:
        API_TOKEN: ${{ secrets.API_TOKEN }}
      run: |
        curl -X PATCH \
        -H "Authorization: token $API_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/repos/$GITHUB_REPOSITORY/issues/${{ github.event.issue.number }} \
        -d '{
        "title": ${{ steps.list_files.outputs.title }},
        "body": ${{ steps.list_files.outputs.body }}
        }'
